<!doctype html>
<html lang="en">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>todolist</title>
<style>
  input[type="text"],
  textarea {
    width: min(100%, 28rem);
    box-sizing: border-box;
  }

  @media (max-width: 600px) {
    input[type="text"],
    textarea {
      width: 100%;
    }
  }

  #actionRow,
  #actionDetails {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  #actionDetails {
    margin-top: 0.5rem;
    margin-bottom: 1rem;
  }

  #actionRow strong {
    margin-right: 0.25rem;
  }

  #actionRow a.active {
    font-weight: 600;
  }

  a.disabled {
    pointer-events: none;
    color: #777;
  }

  .hint {
    color: #666;
    font-size: 0.9rem;
  }
</style>
<body>
  <h1># todolist</h1>
  <a href="settings.html">Settings</a>
  <br><br>

  <div id="actionRow">
    <strong>Actions:</strong>
    <a href="#" id="toggleSelect">Select</a>
    |
    <a href="#" id="actionTask">Task</a>
    |
    <a href="#" id="actionSubtask">Subtask</a>
  </div>
  <div id="actionDetails">
    <span id="primaryActionContainer"></span>
    <span id="secondaryActions" hidden>
      | <a href="#" id="bulkDelete">Delete</a>
    </span>
  </div>


  <h2>Tasks</h2>

  <div id="list"></div>

  <script>
    const LS_KEY = "todolist_v3";
    let tasks = load();
    const selectedIds = new Set();
    let selectMode = false;
    let currentAction = "task";

    function load() { try { return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); } catch { return []; } }
    function save() { localStorage.setItem(LS_KEY, JSON.stringify(tasks)); }

    function loadSettings() {
      try {
        const raw = localStorage.getItem(SETTINGS_KEY);
        if (!raw) return { ...DEFAULT_SETTINGS };
        const parsed = JSON.parse(raw);
        return { ...DEFAULT_SETTINGS, ...parsed };
      } catch {
        return { ...DEFAULT_SETTINGS };
      }
    }

    function todayISODate() {
      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      return now.toISOString().split("T")[0];
    }

    function defaultDueValue() {
      const settings = loadSettings();
      return settings.defaultDue === "today" ? todayISODate() : "";
    }

    function createNode(title, due, notes = "") {
      const normalizedDue = due === undefined ? defaultDueValue() : due;
      return { id: crypto.randomUUID(), title, due: normalizedDue || "", notes, children: [] };
    }

    function findById(list, id) {
      for (const n of list) {
        if (n.id === id) return n;
        const hit = findById(n.children, id);
        if (hit) return hit;
      }
      return null;
    }

    function addChild(parentId, node) {
      const p = findById(tasks, parentId);
      if (p) p.children.push(node);
    }

    function collectIds(list, acc = new Set()) {
      for (const node of list) {
        acc.add(node.id);
        collectIds(node.children, acc);
      }
      return acc;
    }

    function pruneSelection() {
      const validIds = collectIds(tasks, new Set());
      for (const id of Array.from(selectedIds)) {
        if (!validIds.has(id)) selectedIds.delete(id);
      }
    }

    function render() {
      pruneSelection();
      if (!selectMode && selectedIds.size) {
        selectedIds.clear();
      }
      const host = document.getElementById("list");
      host.innerHTML = "";
      host.appendChild(renderList(tasks));
      renderActionDetails();
    }

    function renderList(nodes) {
      const ul = document.createElement("ul");
      for (const n of nodes) {
        const li = document.createElement("li");

        if (selectMode) {
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.checked = selectedIds.has(n.id);
          checkbox.addEventListener("change", (e) => {
            if (e.target.checked) {
              selectedIds.add(n.id);
            } else {
              selectedIds.delete(n.id);
            }
            renderActionDetails();
          });
          li.appendChild(checkbox);
          li.appendChild(document.createTextNode(" "));
        }

        // Title links to edit page
        const a = document.createElement("a");
        a.href = `edit.html#${n.id}`;
        a.textContent = titleWithDue(n);
        li.appendChild(a);

        // Spacing between items
        li.appendChild(document.createElement("br"));

        if (n.children && n.children.length) {
          li.appendChild(renderList(n.children));
        }
        
        ul.appendChild(li);
      }
      return ul;
    }

    function titleWithDue(n) {
      return n.due ? `${n.title || "(untitled)"} (due ${n.due})` : `${n.title || "(untitled)"}`;
    }

    document.getElementById("addRoot").addEventListener("click", (e) => {
      e.preventDefault();
      const input = document.getElementById("newTitle");
      const t = input.value.trim();
      if (!t) { alert("Enter a task title."); return; }
      tasks.push(createNode(t));
      save(); render();
      input.value = "";
    });

    document.getElementById("toggleSelect").addEventListener("click", (e) => {
      e.preventDefault();
      selectMode = !selectMode;
      const link = document.getElementById("toggleSelect");
      link.textContent = selectMode ? "Done" : "Select";
      if (!selectMode) {
        selectedIds.clear();
      }
      render();
    });

    document.getElementById("bulkDelete").addEventListener("click", (e) => {
      e.preventDefault();
      if (selectedIds.size === 0) return;
      if (!confirm("Delete selected tasks?")) return;
      tasks = removeMany(tasks, selectedIds);
      save();
      selectedIds.clear();
      selectMode = false;
      document.getElementById("toggleSelect").textContent = "Select";
      render();
    });

    function removeMany(list, ids) {
      return list.filter(n => {
        if (ids.has(n.id)) return false;
        n.children = removeMany(n.children, ids);
        return true;
      });
    }

    render();
  </script>
</body>
</html>