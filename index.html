<!doctype html>
<html lang="en">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>todolist</title>
<style>
  input[type="text"],
  textarea {
    width: min(100%, 28rem);
    box-sizing: border-box;
  }

  @media (max-width: 600px) {
    input[type="text"],
    textarea {
      width: 100%;
    }
  }

  #actionRow,
  #actionDetails {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  #actionDetails {
    margin-top: 0.5rem;
    margin-bottom: 1rem;
  }

  #actionRow strong {
    margin-right: 0.25rem;
  }

  #actionRow a.active {
    font-weight: 600;
  }

  a.disabled {
    pointer-events: none;
    color: #777;
  }

  .hint {
    color: #666;
    font-size: 0.9rem;
  }
</style>
<body>
  <h1># todolist</h1>
  <a href="settings.html">Settings</a>
  <br><br>

  <div id="actionRow">
    <strong>Actions:</strong>
    <a href="#" id="toggleSelect">Select</a>
    |
    <a href="#" id="actionTask">Task</a>
    |
    <a href="#" id="actionSubtask">Subtask</a>
  </div>
  <div id="actionDetails">
    <span id="primaryActionContainer"></span>
    <span id="secondaryActions" hidden>
      | <a href="#" id="bulkDelete">Delete</a>
    </span>
  </div>


  <h2>Tasks</h2>

  <div id="list"></div>

  <script>
    const LS_KEY = "todolist_v3";
    let tasks = load();
    const selectedIds = new Set();
    let selectMode = false;
    let currentAction = "task";

    function load() { try { return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); } catch { return []; } }
    function save() { localStorage.setItem(LS_KEY, JSON.stringify(tasks)); }

    function loadSettings() {
      try {
        const raw = localStorage.getItem(SETTINGS_KEY);
        if (!raw) return { ...DEFAULT_SETTINGS };
        const parsed = JSON.parse(raw);
        return { ...DEFAULT_SETTINGS, ...parsed };
      } catch {
        return { ...DEFAULT_SETTINGS };
      }
    }

    function todayISODate() {
      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      return now.toISOString().split("T")[0];
    }

    function defaultDueValue() {
      const settings = loadSettings();
      return settings.defaultDue === "today" ? todayISODate() : "";
    }

    function createNode(title, due, notes = "") {
      const normalizedDue = due === undefined ? defaultDueValue() : due;
      return { id: crypto.randomUUID(), title, due: normalizedDue || "", notes, children: [] };
    }

    function findById(list, id) {
      for (const n of list) {
        if (n.id === id) return n;
        const hit = findById(n.children, id);
        if (hit) return hit;
      }
      return null;
    }

    function addChild(parentId, node) {
      const p = findById(tasks, parentId);
      if (p) p.children.push(node);
    }

    function collectIds(list, acc = new Set()) {
      for (const node of list) {
        acc.add(node.id);
        collectIds(node.children, acc);
      }
      return acc;
    }

    function pruneSelection() {
      const validIds = collectIds(tasks, new Set());
      for (const id of Array.from(selectedIds)) {
        if (!validIds.has(id)) selectedIds.delete(id);
      }
    }

    function render() {
      pruneSelection();
      if (!selectMode && selectedIds.size) {
        selectedIds.clear();
      }
      const host = document.getElementById("list");
      host.innerHTML = "";
      host.appendChild(renderList(tasks));
      renderActionDetails();
    }

    function renderList(nodes) {
      const ul = document.createElement("ul");
      for (const n of nodes) {
        const li = document.createElement("li");

        if (selectMode) {
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.checked = selectedIds.has(n.id);
          checkbox.addEventListener("change", (e) => {
            if (e.target.checked) {
              selectedIds.add(n.id);
            } else {
              selectedIds.delete(n.id);
            }
            renderActionDetails();
          });
          li.appendChild(checkbox);
          li.appendChild(document.createTextNode(" "));
        }

        // Title links to edit page
        const a = document.createElement("a");
        a.href = `edit.html#${n.id}`;
        a.textContent = titleWithDue(n);
        li.appendChild(a);

        // Spacing between items
        li.appendChild(document.createElement("br"));

        if (n.children && n.children.length) {
          li.appendChild(renderList(n.children));
        }

        // Extra spacing after each task block
        li.appendChild(document.createElement("br"));
        ul.appendChild(li);
      }
      return ul;
    }

    function titleWithDue(n) {
      return n.due ? `${n.title || "(untitled)"} (due ${n.due})` : `${n.title || "(untitled)"}`;
    }

    document.getElementById("toggleSelect").addEventListener("click", (e) => {
      e.preventDefault();
      selectMode = !selectMode;
      if (!selectMode) {
        selectedIds.clear();
      }
      render();
    });

    document.getElementById("actionTask").addEventListener("click", (e) => {
      e.preventDefault();
      currentAction = "task";
      renderActionDetails();
    });

    document.getElementById("actionSubtask").addEventListener("click", (e) => {
      e.preventDefault();
      currentAction = "subtask";
      renderActionDetails();
    });

    document.getElementById("bulkDelete").addEventListener("click", (e) => {
      e.preventDefault();
      if (selectedIds.size === 0) return;
      if (!confirm("Delete selected tasks?")) return;
      tasks = removeMany(tasks, selectedIds);
      save();
      selectedIds.clear();
      selectMode = false;
      render();
    });

    function removeMany(list, ids) {
      return list.filter(n => {
        if (ids.has(n.id)) return false;
        n.children = removeMany(n.children, ids);
        return true;
      });
    }

    function renderActionDetails() {
      const toggleLink = document.getElementById("toggleSelect");
      toggleLink.classList.toggle("active", selectMode);

      const taskLink = document.getElementById("actionTask");
      const subtaskLink = document.getElementById("actionSubtask");
      taskLink.classList.toggle("active", currentAction === "task");
      subtaskLink.classList.toggle("active", currentAction === "subtask");

      renderPrimaryAction();

      const secondary = document.getElementById("secondaryActions");
      secondary.hidden = selectedIds.size === 0;
    }

    function renderPrimaryAction() {
      const container = document.getElementById("primaryActionContainer");
      const previousTaskInput = document.getElementById("newTitle");
      const previousSubtaskInput = document.getElementById("newSubtaskTitle");
      const previousTaskValue = previousTaskInput?.value || "";
      const previousSubtaskValue = previousSubtaskInput?.value || "";
      const taskWasPresent = Boolean(previousTaskInput);
      const subtaskWasEnabled = previousSubtaskInput ? !previousSubtaskInput.disabled : false;
      container.innerHTML = "";

      if (currentAction === "task") {
        const label = document.createElement("label");
        label.htmlFor = "newTitle";
        label.textContent = "Task";

        const input = document.createElement("input");
        input.id = "newTitle";
        input.type = "text";
        input.placeholder = "e.g., Book flights";
        input.value = previousTaskValue;

        const addLink = document.createElement("a");
        addLink.href = "#";
        addLink.id = "addRoot";
        addLink.textContent = "Add";
        addLink.addEventListener("click", (e) => {
          e.preventDefault();
          const t = input.value.trim();
          if (!t) { alert("Enter a task title."); return; }
          tasks.push(createNode(t));
          save(); render();
          input.value = "";
        });

        container.append(label, document.createTextNode(" "), input, document.createTextNode(" "), addLink);
        if (!taskWasPresent) {
          setTimeout(() => input.focus(), 0);
        }
      } else if (currentAction === "subtask") {
        const label = document.createElement("label");
        label.htmlFor = "newSubtaskTitle";
        label.textContent = "Subtask";

        const input = document.createElement("input");
        input.id = "newSubtaskTitle";
        input.type = "text";
        input.placeholder = "e.g., Call the vendor";
        input.value = previousSubtaskValue;

        const addLink = document.createElement("a");
        addLink.href = "#";
        addLink.id = "addSubtask";
        addLink.textContent = "Add";
        addLink.addEventListener("click", (e) => {
          e.preventDefault();
          if (addLink.classList.contains("disabled")) return;
          const t = input.value.trim();
          if (!t) { alert("Enter a subtask title."); return; }
          const [targetId] = Array.from(selectedIds);
          if (!targetId) { alert("Select a task first."); return; }
          addChild(targetId, createNode(t));
          save(); render();
        });

        const hint = document.createElement("span");
        hint.id = "subtaskHint";
        hint.className = "hint";

        container.append(label, document.createTextNode(" "), input, document.createTextNode(" "), addLink, document.createTextNode(" "), hint);
        updateSubtaskControlsState(input, addLink, hint, subtaskWasEnabled);
      }
    }

    function updateSubtaskControlsState(input, addLink, hint, wasEnabledBefore) {
      if (!selectMode) {
        input.disabled = true;
        addLink.classList.add("disabled");
        addLink.setAttribute("aria-disabled", "true");
        hint.textContent = "Toggle Select to choose a task first.";
      } else if (selectedIds.size === 0) {
        input.disabled = true;
        addLink.classList.add("disabled");
        addLink.setAttribute("aria-disabled", "true");
        hint.textContent = "Select a task to add a subtask.";
      } else if (selectedIds.size > 1) {
        input.disabled = true;
        addLink.classList.add("disabled");
        addLink.setAttribute("aria-disabled", "true");
        hint.textContent = "Select only one task for this action.";
      } else {
        input.disabled = false;
        addLink.classList.remove("disabled");
        addLink.removeAttribute("aria-disabled");
        hint.textContent = "";
        if (!wasEnabledBefore) {
          setTimeout(() => input.focus(), 0);
        }
      }
    }

    render();
  </script>
</body>
</html>
